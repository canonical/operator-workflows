name: Tests

on:
  workflow_call:
    inputs:
      working-directory:
        type: string
        description: The working directory for jobs
        default: './'
    outputs:
      docker-lint-outcome:
        description: |
          The outcome of the docker linting, mainly for the puposes of the tests for this workflow
        value: ${{ jobs.docker-lint.outputs.outcome }}
      metadata-lint-outcome:
        description: |
          The outcome of the metadata.yaml linting, mainly for the puposes of the tests for this
          workflow
        value: ${{ jobs.metadata-lint.outputs.outcome }}
      lint-and-unit-test-outcome:
        description: |
          The outcome of the linting and unit testing, mainly for the puposes of the tests for this
          workflow
        value: ${{ jobs.lint-and-unit-test.outputs.outcome }}

jobs:
  inclusive-naming-check:
    name: Inclusive naming
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v3
        with:
          repository: canonical/Inclusive-naming
          path: ${{ inputs.working-directory }}
      - run: mv * /tmp
      - uses: actions/checkout@v3
      - name: Merge configuration files
        run: |
          # Combine all entries and replace matching elements by
          # .name in .rules for the ones in .woke.yaml
          woke_file=""
          if [ -f .woke.yaml ]; then
            woke_file=".woke.yaml"
          elif [ -f .woke.yml ]; then
            woke_file=".woke.yml"
          fi
          if [ ! -z "$woke_file" ]; then
            yq eval-all '
            (
              . as $item ireduce ({}; . *+ $item) | .rules | unique_by(.name)
            ) as $mergedArray | . as $item ireduce ({}; . *+ $item) | .rules = $mergedArray
            ' $woke_file /tmp/config.yml | tee /tmp/merged.yml
            mv /tmp/merged.yml /tmp/config.yml
          fi
      - name: Run inclusive naming check
        uses: canonical/inclusive-naming@main
        with:
          fail-on-error: "true"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          reporter: github-pr-review
          woke-args: '. -c /tmp/config.yml'
          filter-mode: nofilter
          workdir: ${{ inputs.working-directory }}
          woke-version: latest
  get-runner-image:
    name: Get runner image
    uses: ./.github/workflows/get_runner_image.yaml
  shellcheck-lint:
    name: Shell scripts lint
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v3
      - name: Gather files to scan
        shell: bash
        id: gather
        run: |
          declare -a filepaths
          shebangregex="^#! */[^ ]*/(env *)?[abk]*sh"

          set -f # temporarily disable globbing so that globs in inputs aren't expanded

          while IFS= read -r -d '' file; do
          filepaths+=("$file")
          done < <(find . \
                        -type f \
                        '(' \
                        -name '*.bash' \
                        -o -name '.bashrc' \
                        -o -name 'bashrc' \
                        -o -name '.bash_aliases' \
                        -o -name '.bash_completion' \
                        -o -name '.bash_login' \
                        -o -name '.bash_logout' \
                        -o -name '.bash_profile' \
                        -o -name 'bash_profile' \
                        -o -name '*.ksh' \
                        -o -name 'suid_profile' \
                        -o -name '*.zsh' \
                        -o -name '.zlogin' \
                        -o -name 'zlogin' \
                        -o -name '.zlogout' \
                        -o -name 'zlogout' \
                        -o -name '.zprofile' \
                        -o -name 'zprofile' \
                        -o -name '.zsenv' \
                        -o -name 'zsenv' \
                        -o -name '.zshrc' \
                        -o -name 'zshrc' \
                        -o -name '*.sh' \
                        -o -path '*/.profile' \
                        -o -path '*/profile' \
                        -o -name '*.shlib' \
                        ')' \
                        -print0)

          while IFS= read -r -d '' file; do
          head -n1 "$file" | grep -Eqs "$shebangregex" || continue
          filepaths+=("$file")
          done < <(find . \
                        -type f ! -name '*.*' -perm /111 \
                        -print0)
          echo "filepaths=${filepaths[@]}" >> $GITHUB_OUTPUT
          set +f # re-enable globbing
      - if: ${{ steps.gather.outputs.filepaths != '' }}
        name: Shellcheck Problem Matchers
        uses: lumaxis/shellcheck-problem-matchers@v1.1.2
      - if: ${{ steps.gather.outputs.filepaths != '' }}
        run: shellcheck -f gcc ${{steps.gather.outputs.filepaths}}
  docker-lint:
    name: Dockerfile lint
    runs-on: ubuntu-22.04
    outputs:
      outcome: ${{ steps.report.outputs.outcome }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v3
      - name: Check for Dockerfiles
        id: dockerfiles
        run: echo -n "found=$(find . -name "*Dockerfile" -printf "${{ inputs.working-directory }}%p ")" >> $GITHUB_OUTPUT
      - if: ${{ steps.dockerfiles.outputs.found != '' }}
        name: Run HadoLint
        uses: jbergstroem/hadolint-gh-action@v1
        with:
          dockerfile: "${{ steps.dockerfiles.outputs.found }}"
      - name: Report
        id: report
        run: echo "outcome=$([ '${{ steps.dockerfiles.outputs.found }}' = '' ] && echo skip || echo success)" >> $GITHUB_OUTPUT
  metadata-lint:
    name: Lint metadata.yaml
    runs-on: ubuntu-22.04
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    outputs:
      outcome: ${{ steps.report.outputs.outcome }}
      exists: ${{ steps.metadata.outputs.exists }}
    steps:
      - uses: actions/checkout@v3
      - name: Check file existence
        id: metadata
        run: echo "exists=$([ -f metadata.yaml ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT
      - name: Run lint
        if: steps.metadata.outputs.exists == 'true'
        run: |
          python3 -m pip install check-jsonschema
          curl -fLsSo $PWD/metadata.schema https://raw.githubusercontent.com/canonical/operator-workflows/main/.github/files/metadata.schema
          check-jsonschema metadata.yaml --schemafile metadata.schema
      - name: Report
        id: report
        run: echo "outcome=$([ ${{ steps.metadata.outputs.exists }} = 'true' ] && echo success || echo skip)" >> $GITHUB_OUTPUT
  lint-and-unit-test:
    name: Lint and unit tests
    runs-on: ${{ needs.get-runner-image.outputs.runs-on }}
    needs: get-runner-image
    outputs:
      outcome: ${{ steps.report.outputs.outcome }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v3
      - name: Install tox
        run: python3 -m pip install tox
      - name: Run tests
        run: |
          # Ensure that stdout appears as normal and redirect to file and exit depends on exit code of first command
          tox --result-json=test-result.json | tee stdout.log ; test ${PIPESTATUS[0]} -eq 0
      - name: Check lint and test stdout
        run: |
          # Check dependencies
          EXPECTED_LINT_DEPS="\
              mypy \
              isort \
              black \
              flake8-docstrings \
              flake8-docstrings-complete \
              flake8-builtins \
              flake8-test-docs \
              pep8-naming \
              codespell \
              pylint \
              pydocstyle \
              "
          for EXPECTED_LINT_DEP in $EXPECTED_LINT_DEPS; do
              # Check that there is a `lint...<dependency>` line for each of the expected dependencies
              DEP_REGEX="lint.*$EXPECTED_LINT_DEP"
              if ! grep -q "$DEP_REGEX" stdout.log ; then
                  # Write to stderr
                  >&2 echo "$EXPECTED_LINT_DEP should be in deps of [testenv:lint] environment in tox.ini"
                  exit 1
              fi
          done

          # Check commands
          EXPECTED_LINT_CMDS="\
              pydocstyle \
              codespell \
              flake8 \
              isort \
              black \
              mypy \
              pylint \
              "
          for EXPECTED_LINT_CMD in $EXPECTED_LINT_CMDS; do
              # Check that there is a `lint...commands...<command>` line for each of the expected commands
              CMD_REGEX="lint.*commands.*$EXPECTED_LINT_CMD"
              if ! grep -q "$CMD_REGEX" stdout.log ; then
                  # Write to stderr
                  >&2 echo "$EXPECTED_LINT_CMD should be in commands of [testenv:lint] environment in tox.ini"
                  exit 1
              fi
          done
      - name: Export test report
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const no_color = (text) => {
                return text.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g, '');
            }

            const sha = '${{ github.event.pull_request.head.sha }}';
            const fs = require('fs');
            const result = JSON.parse(fs.readFileSync('${{ inputs.working-directory }}test-result.json')).testenvs;

            let lint_result = result.lint.test;
            let lint_success = true;
            let lint_output = '';
            for (let lint_test_result of lint_result) {
              if (lint_test_result.retcode != 0) {
                lint_success = false;
              }
              if (lint_test_result.output) {
                lint_output += lint_test_result.output;
              }
            }
            let unit_result = result.unit.test;
            let unit_success = unit_result[0].retcode == 0;
            let unit_output = unit_result[0].output;
            let static_result = result.static.test;
            let static_output = static_result[0].output;
            let coverage_result = result["coverage-report"].test;
            let coverage_output = coverage_result[0].output;

            let reports = [];
            if (!lint_success) {
              reports.push(
                `Lint checks failed for ${sha}\n
                \`\`\`\n${no_color(lint_output).trim()}\n\`\`\``
              );
            }
            if (!unit_success) {
              reports.push(
                `Unit tests failed for ${sha}\n
                \`\`\`\n${no_color(unit_output).trim()}\n\`\`\``
              );
            }
            reports.push(
              `Test coverage for ${sha}\n
              \`\`\`\n${no_color(coverage_output).trim()}\n\`\`\`
              Static code analysis report\n
              \`\`\`\n${no_color(static_output).trim()}\n\`\`\``
            );
            let json = JSON.stringify(reports);
            fs.writeFileSync('report.json', json);
      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        if: always() && github.event_name == 'pull_request'
        with:
          name: report
          path: report.json
      - name: Report
        id: report
        run: echo "outcome=success" >> $GITHUB_OUTPUT
  draft-publish-docs:
    name: Draft publish docs
    runs-on: ubuntu-22.04
    needs: metadata-lint
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v3
      - name: Search for metadata and docs key in metadata
        if: needs.metadata-lint.outputs.exists == 'true'
        id: metadata-docs
        run: |
          echo $(grep -q 'docs: https://discourse.charmhub.io/t/' metadata.yaml && echo 'true' || echo 'false' )
          echo "exist=$(grep -q 'docs: https://discourse.charmhub.io/t/' metadata.yaml && echo 'true' || echo 'false' )" >> $GITHUB_OUTPUT
      - name: Publish documentation
        if: needs.metadata-lint.outputs.exists == 'true' && steps.metadata-docs.outputs.exist == 'true'
        uses: canonical/upload-charm-docs@main
        with:
          discourse_host: discourse.charmhub.io
          discourse_api_username: ${{ secrets.DISCOURSE_API_USERNAME }}
          discourse_api_key: ${{ secrets.DISCOURSE_API_KEY }}
          dry_run: true
          github_token: ${{ secrets.GITHUB_TOKEN }}
  lib-check:
    name: Check libraries
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - name: Check libs
        uses: canonical/charming-actions/check-libraries@2.2.1
        with:
          credentials: ${{ secrets.CHARMHUB_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
  required_status_checks:
    name: Required Test Status Checks
    runs-on: ubuntu-latest
    needs:
      - draft-publish-docs
      - docker-lint
      - inclusive-naming-check
      - lib-check
      - lint-and-unit-test
      - metadata-lint
      - shellcheck-lint
    steps:
      - run: echo required checks passed
