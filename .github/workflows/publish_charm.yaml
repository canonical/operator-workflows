# Copyright 2023 Canonical Ltd.
# See LICENSE file for licensing details.

name: Publish charm

on:
  workflow_call:
    inputs:
      channel:
        required: true
        type: string
        description: 'Origin Channel'
      images:
        type: string
        description: 'Docker images'
      working-directory:
        type: string
        description: The working directory for jobs
        default: "./"
    permissions:
      contents: read

jobs:
  get-runner-image:
    name: Get runner image
    uses: ./.github/workflows/get_runner_image.yaml
    with:
      working-directory: ${{ inputs.working-directory }}
  release-charm-libs:
    name: Release charm libs
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - if: inputs.working-directory != './'
        name: Change directory
        run: |
          TEMP_DIR=$(mktemp -d)
          cp -rp ${{inputs.working-directory}}/. $TEMP_DIR
          rm -rf .* * || :
          cp -rp $TEMP_DIR/. .
          rm -rf $TEMP_DIR
      - uses: canonical/charming-actions/release-libraries@2.3.0
        name: Release libs
        with:
          credentials: ${{ secrets.CHARMHUB_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
  get-pr-number:
    name: Get PR triggering the change
    runs-on: ubuntu-22.04
    outputs:
      pr-number: ${{ fromJson(steps.get-issue-number.outputs.data)[0].number
    steps:
      - uses: octokit/request-action@v2.x
        id: get-issue-number
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        with:
          route: GET /repos/{owner}/{repo}/commits/{commit_sha}/pulls
          repo: context.repo.repo
          owner: context.repo.owner
          commit_sha: context.sha
  publish-images:
    name: Publish images to charmhub
    runs-on: ${{ needs.get-runner-image.outputs.runs-on }}
    needs: [get-pr-number, get-runner-image]
    if: ${{ inputs.images != '[]' }}
    strategy:
      matrix:
        image: ${{ fromJSON(inputs.images) }}
    steps:
      - uses: actions/checkout@v3
      - if: inputs.working-directory != './'
        name: Change directory
        run: |
          TEMP_DIR=$(mktemp -d)
          cp -rp ${{inputs.working-directory}}/. $TEMP_DIR
          rm -rf .* * || :
          cp -rp $TEMP_DIR/. .
          rm -rf $TEMP_DIR
      - name: Install charmcraft
        run: sudo snap install charmcraft --classic
      - name: Download docker artifacts
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          if_no_artifact_found: warn
          name: ${image_name}.tar
          pr: ${{ jobs.get-issue-number.outputs.pr-number }}
          workflow: build_images.yaml
          workflow_conclusion: success
      - name: Download rock artifacts
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          if_no_artifact_found: warn
          name: ${image_name}.tar
          pr: ${{ jobs.get-issue-number.outputs.pr-number }}
          workflow: build_rocks.yaml
          workflow_conclusion: success
      - name: Publish image
        env:
          CHARMCRAFT_AUTH:  ${{ secrets.CHARMHUB_TOKEN }}
        run: |
          imageFile=${image_name}/${image_name}.tar
          charmName=$(yq '.name' metadata.yaml)
          charmcraft upload-resource $charmName ${{ matrix.image }}-image --filepath=$imageFile --verbosity=trace
  publish-charm:
    name: Publish charm to ${{ inputs.channel }}
    runs-on: ${{ needs.get-runner-image.outputs.runs-on }}
    needs: [get-pr-number, get-runner-image, publish-images]
    if: ${{ !failure() }}
    steps:
      - uses: actions/checkout@v3
      - if: inputs.working-directory != './'
        name: Change directory
        run: |
          TEMP_DIR=$(mktemp -d)
          cp -rp ${{inputs.working-directory}}/. $TEMP_DIR
          rm -rf .* * || :
          cp -rp $TEMP_DIR/. .
          rm -rf $TEMP_DIR
      - name: Get charm name
        id: get-charm-name
        run: echo "charm_name=$(yq '.name' metadata.yaml)" >> $GITHUB_OUTPUT
      - name: Download charm artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{secrets.GITHUB_TOKEN}}
          name: ${{ steps.get-charm-name.outputs.charm_name }}.tar
          pr: ${{ jobs.get-issue-number.outputs.pr-number }}
          workflow: build_rintegration_test.yaml
          workflow_conclusion: success
      - name: Upload charm to charmhub
        uses: canonical/charming-actions/upload-charm@2.3.0
        with:
          built-charm-path: ${{ steps.get-charm-name.outputs.charm_name }}.tar
          credentials: ${{ secrets.CHARMHUB_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          channel: ${{ inputs.channel }}
          upload-image: false
