# Copyright 2023 Canonical Ltd.
# See LICENSE file for licensing details.

name: Publish charm

on:
  workflow_call:
    inputs:
      channel:
        required: true
        type: string
        description: 'Origin Channel'
      working-directory:
        type: string
        description: The working directory for jobs
        default: "./"

jobs:
  branch-up-to-date-check-enabled:
    runs-on: ubuntu-22.04
    steps:
      - uses: octokit/request-action@v2.x
        id: get-branch-protection
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        with:
          route: GET /repos/{owner}/{repo}/branches/{branch}/protection/required_status_checks
          repo: ${{ github.event.repository.name }}
          owner: ${{ github.event.repository.owner.login }}
          branch: main
      - run: |
          if [ ${{ fromJson(steps.get-branch-protection.outputs.data).strict }} != "true" ]; then
            echo "::error::Strict checks are not enabled for this repository"
            exit 1
          fi
  get-runner-image:
    name: Get runner image
    uses: ./.github/workflows/get_runner_image.yaml
    with:
      working-directory: ${{ inputs.working-directory }}
  release-charm-libs:
    name: Release charm libs
    needs: [ branch-up-to-date-check-enabled ]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
      - if: inputs.working-directory != './'
        name: Change directory
        run: |
          TEMP_DIR=$(mktemp -d)
          cp -rp ${{inputs.working-directory}}/. $TEMP_DIR
          rm -rf .* * || :
          cp -rp $TEMP_DIR/. .
          rm -rf $TEMP_DIR
      - uses: canonical/charming-actions/release-libraries@2.3.0
        name: Release libs
        with:
          credentials: ${{ secrets.CHARMHUB_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
  get-commit-sha:
    name: Get commit SHA
    needs: [ branch-up-to-date-check-enabled ]
    runs-on: ubuntu-22.04
    outputs:
      sha: ${{ env.LAST_COMMIT_SHA }}
      wf-path: ${{ env.WF_PATH }}
      wf-status: ${{ env.WF_STATUS }}
    steps:
      - name: Setup Environment (PR)  
        if: ${{ github.event_name == 'pull_request' }}  
        shell: bash  
        run: |
          echo "WF_STATUS=in_progress" >> ${GITHUB_ENV}
          echo "WF_PATH=.github/workflows/workflow_test.yaml" >> ${GITHUB_ENV}
          echo "LAST_COMMIT_SHA=${{ github.event.pull_request.head.sha }}" >> ${GITHUB_ENV}  
      - name: Setup Environment (Push)  
        if: ${{ github.event_name == 'push' }}  
        shell: bash  
        run: |
          echo "WF_STATUS=success" >> ${GITHUB_ENV}
          echo "WF_PATH=.github/workflows/integration_test.yaml" >> ${GITHUB_ENV}
          echo "LAST_COMMIT_SHA=${GITHUB_SHA}" >> ${GITHUB_ENV}
  get-images:
    name: Get images
    runs-on: ubuntu-22.04
    outputs:
      images: ${{ env.IMAGES }}
    steps:
      - uses: actions/checkout@v3
      - name: Get images
        working-directory: ${{ inputs.working-directory }}
        run: |
          lines=$(find . -type f -name rockcraft.yaml | wc -l)
          if [ $lines -ne 0 ]; then
            IMAGES=$(find . -type f -name rockcraft.yaml | xargs -l yq '.name' | jq -Rsc '. / "\n" - [""]')
          else
            IMAGES=$(ls *.Dockerfile 2> /dev/null | sed s/\.Dockerfile// |  jq -Rsc '. / "\n" - [""]')
          fi
          echo "IMAGES=$IMAGES" >> $GITHUB_ENV
  publish-images:
    name: Publish images to charmhub
    runs-on: ${{ needs.get-runner-image.outputs.runs-on }}
    needs: [ get-images, get-commit-sha, get-runner-image]
    if: ${{ needs.get-images.outputs.images != '[]' }}
    strategy:
      matrix:
        image: ${{ fromJSON(needs.get-images.outputs.images) }}
    steps:
      - uses: actions/checkout@v3
      - if: inputs.working-directory != './'
        name: Change directory
        run: |
          TEMP_DIR=$(mktemp -d)
          cp -rp ${{inputs.working-directory}}/. $TEMP_DIR
          rm -rf .* * || :
          cp -rp $TEMP_DIR/. .
          rm -rf $TEMP_DIR
      - name: Install charmcraft
        run: |
          sudo snap install charmcraft --classic
      - name: Download image artifacts
        run: |
          RUN_IDS=$(gh api \
            --method GET \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/runs \
            -f status=${{ needs.get-commit-sha.outputs.wf-status }} \
            -f head_sha=${{ needs.get-commit-sha.outputs.sha }} \
            -f event=pull_request \
            --jq '[.workflow_runs[] | select(.path == "./.github/workflows/integration_test.yaml") | .id]')
          [[ $(echo $RUN_IDS | jq length) -eq 0 ]] && echo no workflow found && exit 1
          [[ $(echo $RUN_IDS | jq length) -gt 1 ]] && echo multiple workflows found && exit 1
          RUN_ID=$(echo $RUN_IDS | jq ".[0]")
          echo $RUN_ID
          echo ${{ github.repository }}
          echo ${{ matrix.image }}
          gh run download $RUN_ID -R ${{ github.repository }} -n ${{ matrix.image }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Publish image
        env:
          CHARMCRAFT_AUTH:  ${{ secrets.CHARMHUB_TOKEN }}
        run: |
          tree
          imageFile=${matrix.image}/${matrix.image}.tar
          charmName=$(yq '.name' metadata.yaml)
          charmcraft upload-resource $charmName ${{ matrix.image }}-image --filepath=$imageFile --verbosity=trace
  publish-charm:
    name: Publish charm to ${{ inputs.channel }}
    runs-on: ${{ needs.get-runner-image.outputs.runs-on }}
    needs: [get-commit-sha, get-runner-image, publish-images]
    if: ${{ !failure() }}
    steps:
      - uses: actions/checkout@v3
      - if: inputs.working-directory != './'
        name: Change directory
        run: |
          TEMP_DIR=$(mktemp -d)
          cp -rp ${{inputs.working-directory}}/. $TEMP_DIR
          rm -rf .* * || :
          cp -rp $TEMP_DIR/. .
          rm -rf $TEMP_DIR
      - name: Get charm name
        id: get-charm-name
        run: echo "charm_name=$(yq '.name' metadata.yaml)" >> $GITHUB_OUTPUT
      - name: Download charm artifact
        run: |
          RUN_IDS=$(gh api \
            --method GET \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/actions/runs \
            -f status=${{ needs.get-commit-sha.outputs.wf-status }} \
            -f head_sha=${{ needs.get-commit-sha.outputs.sha }} \
            -f event=pull_request \
            --jq '[.workflow_runs[] | select(.path == ${{ needs.get-commit-sha.outputs.wf-path }}) | .id]')
          [[ $(echo $RUN_IDS | jq length) -eq 0 ]] && echo no workflow found && exit 1
          [[ $(echo $RUN_IDS | jq length) -gt 1 ]] && echo multiple workflows found && exit 1
          RUN_ID=$(echo $RUN_IDS | jq ".[0]")
          gh run download $RUN_ID -R ${{ github.repository }} -n ${{ steps.get-charm-name.outputs.charm_name }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload charm to charmhub
        uses: canonical/charming-actions/upload-charm@2.3.0
        with:
          built-charm-path: ${{ steps.get-charm-name.outputs.charm_name }}.tar
          credentials: ${{ secrets.CHARMHUB_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          channel: ${{ inputs.channel }}
          upload-image: false
