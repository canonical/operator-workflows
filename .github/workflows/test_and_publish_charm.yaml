# Copyright 2023 Canonical Ltd.
# See LICENSE file for licensing details.

name: Test and publish charm

on:
  workflow_call:
    inputs:
      channel:
        description: Destination channel to push the charm to
        type: string
        default: 'latest/edge'
      working-directory:
        type: string
        description: The working directory for jobs
        default: "./"

jobs:
  branch-up-to-date-check-enabled:
    runs-on: ubuntu-22.04
    steps:
      - uses: octokit/request-action@v2.x
        id: get-branch-protection
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        with:
          route: GET /repos/{owner}/{repo}/branches/{branch}/protection/required_status_checks
          repo: context.repo.repo
          owner: context.repo.owner
          branch: main
      - run: |
          if [ ${{ fromJson(steps.get-branch-protection.outputs.data).strict }} != "true" ]; then
            exit 1
          fi
  publish-charm:
    name: Publish
    uses: ./.github/workflows/publish_charm.yaml
    needs: [ branch-up-to-date-check-enabled, lib-check, tests, integration-tests ]
    with:
      channel: ${{ inputs.channel }}
      images: ${{ needs.integration-tests.outputs.images }}
      working-directory: ${{ inputs.working-directory }}
    secrets: inherit
