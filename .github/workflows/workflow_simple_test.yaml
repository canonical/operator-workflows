# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.

name: Workflow Unit Tests

on:
  pull_request:

jobs:
  simple:
    uses: ./.github/workflows/test.yaml
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.10"
          - "3.12"
    with:
      working-directory: "tests/workflows/integration/test-upload-charm/"
      self-hosted-runner: false
      python-version: ${{ matrix.python-version }}
      vale-files: '["docs/**/*.md", "README.md"]'
      vale-style-check: true
      with-uv: true
  simple-self-hosted:
    uses: ./.github/workflows/test.yaml
    secrets: inherit
    with:
      working-directory: "tests/workflows/integration/test-upload-charm/"
      self-hosted-runner: true
      self-hosted-runner-label: "edge"
      vale-files: '["docs/**/*.md", "README.md"]'
      vale-style-check: true
      with-uv: true
  node-package-tests:
    name: Node package build and test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Build (package)
        run: npm run package
      - name: Test (ci-test)
        run: npm run ci-test -- --ci
  check:
    runs-on: ubuntu-latest
    if: always() && !cancelled()
    timeout-minutes: 5
    needs:
      - simple
      - simple-self-hosted
      - node-package-tests
    steps:
      - run: |
          [ '${{ needs.simple.result }}' = 'success' ] || (echo simple failed && false)
          [ '${{ needs.simple-self-hosted.result }}' = 'success' ] || (echo simple-self-hosted failed && false)
          [ '${{ needs.node-package-tests.result }}' = 'success' ] || (echo node-package-tests failed && false)

  test-comment:
    name: Comment on the pull request
    uses: ./.github/workflows/comment.yaml
    if: always() && !cancelled()
    needs:
      - simple
      - simple-self-hosted
      - node-package-tests
