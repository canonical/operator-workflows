# Copyright 2025 Canonical Ltd.
# See LICENSE file for licensing details.

name: Workflow Unit Tests

on:
  pull_request:

jobs:
  simple:
    uses: ./.github/workflows/test.yaml
    secrets: inherit
    strategy:
      fail-fast: false
      matrix:
        python-version:
          - "3.10"
          - "3.12"
    with:
      working-directory: "tests/workflows/integration/test-upload-charm/"
      self-hosted-runner: false
      python-version: ${{ matrix.python-version }}
      vale-files: '["docs/**/*.md", "README.md"]'
      vale-style-check: true
      with-uv: true
  simple-self-hosted:
    uses: ./.github/workflows/test.yaml
    secrets: inherit
    with:
      working-directory: "tests/workflows/integration/test-upload-charm/"
      self-hosted-runner: true
      self-hosted-runner-label: "edge"
      vale-files: '["docs/**/*.md", "README.md"]'
      vale-style-check: true
      with-uv: true
  node-package-tests:
    name: Node package build and test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Build (package)
        run: npm run package
      - name: Verify dist up-to-date for changed entries
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          # Only check dist outputs corresponding to changed src entry files
          changed=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" -- src/*.ts || true)
          if [ -z "$changed" ]; then
            echo "No src/*.ts entry changes; skipping dist check."
            exit 0
          fi
          echo "$changed" | while read -r f; do
            [ -n "$f" ] || continue
            name="$(basename "$f" .ts)"
            if ! git --no-pager diff --exit-code -- "dist/$name/"; then
              echo "Build output differs for dist/$name/. Run 'npm run package' locally and commit changes."
              git --no-pager diff --stat -- "dist/$name/"
              exit 1
            fi
          done
  check:
    runs-on: ubuntu-latest
    if: always() && !cancelled()
    timeout-minutes: 5
    needs:
      - simple
      - simple-self-hosted
      - node-package-tests
    steps:
      - run: |
          [ '${{ needs.simple.result }}' = 'success' ] || (echo simple failed && false)
          [ '${{ needs.simple-self-hosted.result }}' = 'success' ] || (echo simple-self-hosted failed && false)
          [ '${{ needs.node-package-tests.result }}' = 'success' ] || (echo node-package-tests failed && false)

  test-comment:
    name: Comment on the pull request
    uses: ./.github/workflows/comment.yaml
    if: always() && !cancelled()
    needs:
      - simple
      - simple-self-hosted
      - node-package-tests
